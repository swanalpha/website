<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-WJJX7CQ79D"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-WJJX7CQ79D');
  </script>  
  <meta charset="UTF-8" />
  <title>SWAN Alpha — Daily Market Regime Signal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta
    name="description"
    content="Daily SPY market regime signal with a live overlay, historical backtests, and example SWAN portfolio performance."
  />
  <link rel="icon" href="/favicon.ico" />

  <!-- Tailwind (local build) -->
  <link rel="stylesheet" href="assets/tailwind.css" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
    rel="stylesheet"
  />

  <!-- Lightweight Charts v5 (local copy) -->
  <script src="assets/lightweight-charts.production.min.js"></script>

  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    .hero-buckets {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.75rem;
    }
    .regime-comparison {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    @media (min-width: 768px) {
      .regime-comparison {
        flex-direction: row;
        align-items: flex-start;
      }
      .regime-comparison > .regime-item {
        flex: 1 1 50%;
      }
    }
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <!-- Page wrapper -->
  <div class="min-h-screen flex flex-col">

    <!-- Top nav -->
    <header class="border-b border-slate-800 bg-slate-950/90 backdrop-blur">
      <div class="max-w-6xl mx-auto flex items-center justify-between px-4 py-3">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-xl bg-gradient-to-br from-emerald-400 via-emerald-500 to-sky-500 shadow-lg shadow-emerald-500/30 flex items-center justify-center">
            <span class="text-slate-950 font-black text-lg">S</span>
          </div>
          <div class="leading-tight">
            <div class="text-sm font-semibold tracking-wide">SWAN Alpha</div>
            <div class="text-[11px]">Sleep <span class="text-emerald-400">Well</span>. Stay <span class="text-emerald-400">Invested</span>.</div>
          </div>
        </div>
      </div>
    </header>

    <!-- Main content -->
    <main class="flex-1">
      <div class="max-w-6xl mx-auto px-4 py-6 md:py-10 space-y-8">

        <!-- Hero / Today’s signal -->
        <section class="grid md:grid-cols-[2fr,1.1fr] gap-6 items-start">
          <div class="space-y-4 text-slate-400">
            <span class="text-3xl font-semibold tracking-tight text-emerald-400">
              SWAN Alpha
            </span>
            is a quantitative framework for serious, hands-on investors who want equity-like returns with more controlled risk and drawdowns.
            <ul class="mt-4 hero-buckets text-[13px]">
              <li class="h-full rounded-lg border border-slate-800 bg-slate-900/60 p-3 shadow-sm shadow-emerald-500/10">
                <div class="text-emerald-400 font-semibold mb-1 text-lg">Regime Signals</div>
                <div class="text-slate-300/90">Data-driven regime classification to show when conditions favor taking risk and when they call for defense.</div>
              </li>
              <li class="h-full rounded-lg border border-slate-800 bg-slate-900/60 p-3 shadow-sm shadow-emerald-500/10">
                <div class="text-emerald-400 font-semibold mb-1 text-lg">Model Portfolios</div>
                <div class="text-slate-300/90">Allocations tuned to each regime, designed to balance return and drawdown. <i>(Upcoming)</i></div>
              </li>
              <li class="h-full rounded-lg border border-slate-800 bg-slate-900/60 p-3 shadow-sm shadow-emerald-500/10">
                <div class="text-emerald-400 font-semibold mb-1 text-lg">Alpha Overlays</div>
                <div class="text-slate-300/90">Tactical models (e.g., pullback / bottom tools) aiming to enhance returns without abandoning risk discipline. <i>(Upcoming)</i></div>
              </li>
            </ul>
          </div>
          <div class="space-y-3">
            <div class="bg-slate-900/60 border border-slate-800 rounded-xl p-3 space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-slate-400">Current Regime</span>
                <span id="spy-as-of" class="text-slate-500 text-[11px]"></span>
              </div>
              <div class="flex items-center gap-3">
                <span id="spy-regime-pill"
                      class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-800 text-slate-100">
                  Loading...
                </span>
                <span id="spy-pbull" class="text-xs text-slate-300"></span>
              </div>
              <div id="spy-confidence" class="text-[11px] text-slate-400"></div>
              <div class="flex flex-wrap gap-3 text-[11px] text-slate-400">
                <div class="flex items-center gap-1.5">
                  <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                  Bull: higher equity exposure
                </div>
                <div class="flex items-center gap-1.5">
                  <span class="h-2 w-2 rounded-full bg-rose-500"></span>
                  Bear: defensive / high cash
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Live SPY regime & price chart -->
        <section class="space-y-3">
          <div class="flex items-center justify-between gap-2">
            <h2 class="text-sm md:text-base font-semibold text-slate-100">
              SPY Price with Live Regime Signals
            </h2>
          </div>

          <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-3 md:p-4 space-y-3">
            <div id="spy-price-chart" class="h-72 md:h-80"></div>
            <div id="spy-regime-strip" class="hidden h-0 mt-0"></div>
          </div>
        </section>

        <!-- Live performance section -->
        <section class="space-y-6">
          <h2 class="text-sm md:text-base font-semibold text-slate-100">
            Regime-Based Exposure vs. Buy &amp; Hold
          </h2>

          <div class="regime-comparison">
            <div class="regime-item text-slate-400 leading-relaxed">
              “Regime-Based Exposure” adjusts SPY or portfolio allocation based on a quantitative view of the current market regime, while “Buy &amp; Hold” stays 100% invested at all times. This dynamic approach aims to preserve most of SPY’s long-term return with much smaller drawdowns.
            </div>

            <div class="regime-item bg-slate-900/60 border border-slate-800 rounded-2xl p-3 md:p-4">
              <div class="text-[11px] text-slate-500 mb-2 flex items-center justify-between">
                <span>Live SPY performance comparison</span>
                <span id="spy-live-range" class="text-[11px] text-slate-500"></span>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full min-w-[360px] text-[12px] text-left">
                  <thead class="text-slate-400">
                    <tr>
                      <th class="py-1 pr-3 font-medium">Strategy</th>
                      <th class="py-1 pr-3 font-medium">CAGR</th>
                      <th class="py-1 pr-3 font-medium">Sharpe</th>
                      <th class="py-1 pr-3 font-medium">MaxDD</th>
                    </tr>
                  </thead>
                  <tbody class="text-slate-200/90">
                    <tr>
                      <td class="py-1 pr-3 text-slate-400">Regime-Based Exposure</td>
                      <td id="spy-live-cagr" class="py-1 pr-3 font-semibold text-emerald-400">–</td>
                      <td id="spy-live-sharpe" class="py-1 pr-3 font-semibold text-emerald-400">–</td>
                      <td id="spy-live-maxdd" class="py-1 pr-3 font-semibold text-rose-400">–</td>
                    </tr>
                    <tr>
                      <td class="py-1 pr-3 text-slate-400">Buy &amp; Hold</td>
                      <td id="spy-live-cagr-bench" class="py-1 pr-3 text-slate-300">–</td>
                      <td id="spy-live-sharpe-bench" class="py-1 pr-3 text-slate-300">–</td>
                      <td id="spy-live-maxdd-bench" class="py-1 pr-3 text-rose-300">–</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="space-y-3">
            <div class="flex items-center justify-between gap-2">
              <div class="text-[11px] text-slate-500">
                Starting value $1,000,000 · close-to-close · no costs
              </div>
            </div>
            <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-3 md:p-4">
              <div id="spy-equity-chart" class="h-60 md:h-64"></div>
              <div class="mt-2 flex flex-wrap gap-3 text-[11px] text-slate-400">
                <div class="flex items-center gap-1.5">
                  <span class="inline-block h-2 w-4 rounded bg-emerald-400"></span>
                  Regime-based SPY allocation
                </div>
                <div class="flex items-center gap-1.5">
                  <span class="inline-block h-2 w-4 rounded bg-sky-400"></span>
                  SPY Buy &amp; Hold
                </div>
              </div>
            </div>
          </div>

          <!-- Backtest summary -->
          <div class="space-y-3">
            <div class="flex items-center justify-between gap-2">
              <div>
                <h2 class="text-sm md:text-base font-semibold text-slate-100">
                  Backtest Result from 2005 to 2024
                </h2>
                <div class="text-[11px] text-slate-500">
                  Same rules as the live Regime-Based SPY Allocation, applied to SPY historically.
                </div>
              </div>
              <div class="text-[11px] text-slate-500" id="bt-range-label">
                close-to-close, no costs
              </div>
            </div>
            <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-4">
              <div class="grid md:grid-cols-[2fr,1fr] gap-4 items-start">
                <div>
                  <div class="overflow-x-auto max-w-6xl">
                    <table class="w-full md:w-auto min-w-[560px] text-[11px] text-left border-separate border-spacing-y-1">
                      <thead class="text-slate-400">
                        <tr>
                          <th class="pr-3 pb-1">Period</th>
                          <th class="pr-3 pb-1">Strategy</th>
                          <th class="pr-3 pb-1 text-right">CAGR</th>
                          <th class="pr-3 pb-1 text-right">Sharpe</th>
                          <th class="pr-3 pb-1 text-right">MaxDD</th>
                        </tr>
                      </thead>
                      <tbody id="bt-subperiod-body">
                        <!-- Rows injected by JS -->
                      </tbody>
                    </table>
                  </div>
                </div>

                <div class="text-[11px] text-slate-500 space-y-1">
                  <p class="font-semibold text-slate-300">Disclaimers</p>
                  <ul class="space-y-0.5">
                    <li>Backtests are hypothetical and do not reflect actual trading or execution costs.</li>
                    <li>Transaction costs, taxes, and slippage are not modelled.</li>
                    <li>Historical performance is not a guarantee of future results.</li>
                    <li>The live signal may underperform SPY or incur losses over any horizon.</li>
                    <li>These results are for research and educational purposes only and do not constitute investment advice or an offer to invest in any product.</li>
                  </ul>
                </div>
              </div>
            </div>              
          </div>
        </section>

        <section class="space-y-6 pt-2">
        <!-- SWAN live comparison -->
          <div class="space-y-3">
            <h2 class="text-sm md:text-base font-semibold text-slate-100">
              Live SWAN Portfolio Performance
            </h2>
            <p class="text-slate-400">
              The SWAN Portfolio is a live model portfolio that applies the SWAN Alpha regime-based allocation framework to a diversified mix of assets. It aims to improve the risk/return profile relative to a simple SPY Buy &amp; Hold approach. The chart shows its real-time performance since launch, compared with SPY and an internal SWAN Buy &amp; Hold benchmark.
            </p>

            <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-3 md:p-4 space-y-3">
              <div class="flex flex-wrap gap-3 text-[11px] text-slate-300">
                <div class="flex items-center gap-2">
                  <span class="font-semibold text-emerald-300">SWAN + Regime</span>
                  <span id="swan-live-overlay-metrics" class="text-slate-400">(CAGR: –, Sharpe: –)</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="font-semibold text-orange-300">SWAN B&amp;H</span>
                  <span id="swan-live-bh-metrics" class="text-slate-400">(CAGR: –, Sharpe: –)</span>
                </div>
                <div class="flex items-center gap-2">
                  <span class="font-semibold text-sky-300">SPY B&amp;H</span>
                  <span id="swan-live-spy-metrics" class="text-slate-400">(CAGR: –, Sharpe: –)</span>
                </div>
              </div>
              <div id="swan-equity-chart" class="h-56"></div>
              <div class="mt-2 flex flex-wrap gap-3 text-[11px] text-slate-400">
                <div class="flex items-center gap-1.5">
                  <span class="inline-block h-2 w-4 rounded bg-emerald-400"></span>
                  SWAN + Regime
                </div>
                <div class="flex items-center gap-1.5">
                  <span class="inline-block h-2 w-4 rounded bg-orange-400"></span>
                  SWAN Buy &amp; Hold
                </div>
                <div class="flex items-center gap-1.5">
                  <span class="inline-block h-2 w-4 rounded bg-sky-400"></span>
                  SPY Buy &amp; Hold
                </div>
              </div>
            </div>
            <div class="flex items-center justify-between gap-2">
              <div class="text-[11px] text-slate-500">
                Portfolio details and allocation strategy not disclosed · performance is real-time
              </div>
            </div>
          </div>
        </section>

      </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-800 mt-6">
      <div class="max-w-6xl mx-auto px-4 py-3 flex flex-wrap items-center justify-between gap-2 text-[11px] text-slate-500">
        <span>© <span id="footer-year"></span> SWAN Alpha (personal research project).</span>
        <span>This site is for informational and educational purposes only. Not investment advice.</span>
      </div>
    </footer>
  </div>

  <!-- Page script -->
  <script>
    const CONFIG = {
      spySnapshotUrl: 'data/live_snapshot.json',
      swanSnapshotUrl: 'data/live_snapshot_swan.json',
      backtestSpyUrl: 'data/backtest_summary.json',
    };

    const { createChart } = LightweightCharts;

    function fmtPct(x, digits = 1) {
      if (x === null || x === undefined || isNaN(x)) return '–';
      return (x * 100).toFixed(digits) + '%';
    }

    function fmtPctSigned(x, digits = 1) {
      if (x === null || x === undefined || isNaN(x)) return '–';
      const v = (x * 100).toFixed(digits);
      return (x >= 0 ? '+' : '') + v + '%';
    }

    function fmtNumber(x, digits = 0) {
      if (x === null || x === undefined || isNaN(x)) return '–';
      return Number(x).toLocaleString(undefined, {
        maximumFractionDigits: digits,
      });
    }

    function fmtDateStr(s) {
      if (!s) return '';
      return s;
    }

    // ------------------------------------------------------------
    // 1) Load JSONs and drive the page
    // ------------------------------------------------------------

    async function loadJson(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Failed to load ' + url);
      return res.json();
    }

    async function initPage() {
      document.getElementById('footer-year').textContent =
        new Date().getFullYear();

      let spySnap = null;
      let swanSnap = null;
      let btSpy = null;

      try {
        [spySnap, swanSnap, btSpy] = await Promise.all([
          loadJson(CONFIG.spySnapshotUrl),
          loadJson(CONFIG.swanSnapshotUrl).catch(() => null),
          loadJson(CONFIG.backtestSpyUrl).catch(() => null),
        ]);
      } catch (err) {
        console.error('Error loading data:', err);
      }

      if (spySnap) {
        renderSpyHeader(spySnap);
        renderSpyPriceAndRegimeCharts(spySnap);
        renderSpyEquityChart(spySnap);
      }

      if (swanSnap) {
        renderSwanStatsAndChart(swanSnap);
      }

      if (btSpy) {
        renderBacktest(btSpy);
      }
    }

    // ------------------------------------------------------------
    // 2) SPY header (regime + live stats)
    // ------------------------------------------------------------

    function renderSpyHeader(snap) {
      const cur = snap.current || {};
      const stats = snap.stats_live_overlay || {};
      const statsBench = snap.stats_live_spy_bh || snap.stats_live_spy || {};

      const asOf = snap.as_of || stats.end_date || '';

      const regime = String(cur.regime || 'UNKNOWN').toUpperCase();
      const pBull = cur.p_bull;
      const confidence = cur.confidence || '';
      const score = cur.regime_score;

      const pill = document.getElementById('spy-regime-pill');
      const asOfEl = document.getElementById('spy-as-of');
      const pBullEl = document.getElementById('spy-pbull');
      const confEl = document.getElementById('spy-confidence');
      const rangeEl = document.getElementById('spy-live-range');
      const cagrEl = document.getElementById('spy-live-cagr');
      const cagrBenchEl = document.getElementById('spy-live-cagr-bench');
      const sharpeEl = document.getElementById('spy-live-sharpe');
      const maxDdEl = document.getElementById('spy-live-maxdd');
      const sharpeBenchEl = document.getElementById('spy-live-sharpe-bench');
      const maxDdBenchEl = document.getElementById('spy-live-maxdd-bench');

      pill.textContent = regime;
      if (regime === 'BULL') {
        pill.className =
          'inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-emerald-500/10 text-emerald-300 border border-emerald-500/40';
      } else if (regime === 'BEAR') {
        pill.className =
          'inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-rose-500/10 text-rose-300 border border-rose-500/40';
      } else {
        pill.className =
          'inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-slate-700 text-slate-100';
      }

      asOfEl.textContent = asOf ? `as of ${fmtDateStr(asOf)}` : '';

      if (pBull !== undefined && pBull !== null) {
        const pct = fmtPct(pBull, 1);
        pBullEl.textContent =
          regime === 'BULL'
            ? `P(bull) ≈ ${pct}`
            : `P(bear) ≈ ${fmtPct(1 - pBull, 1)}`;
      } else {
        pBullEl.textContent = '';
      }

      const pieces = [];
      if (confidence) pieces.push(`Confidence: ${confidence}`);
      if (score !== undefined && score !== null) {
        pieces.push(`Regime score: ${(score * 100).toFixed(0)}/100`);
      }
      pieces.push("by SWAN Alpha Engine")
      confEl.textContent = pieces.join(' · ');

      if (stats.start_date && stats.end_date) {
        rangeEl.textContent = `${stats.start_date} → ${stats.end_date}`;
      }

      cagrEl.textContent = fmtPct(stats.cagr ?? NaN, 1);
      cagrBenchEl.textContent = fmtPct(statsBench.cagr ?? NaN, 1);
      sharpeEl.textContent = (stats.sharpe ?? NaN).toFixed
        ? stats.sharpe.toFixed(2)
        : '–';
      if (maxDdEl) {
        maxDdEl.textContent = fmtPct(stats.max_dd ?? NaN, 1);
      }
      if (sharpeBenchEl) {
        sharpeBenchEl.textContent = (statsBench.sharpe ?? NaN).toFixed
          ? statsBench.sharpe.toFixed(2)
          : '–';
      }
      if (maxDdBenchEl) {
        maxDdBenchEl.textContent = fmtPct(statsBench.max_dd ?? NaN, 1);
      }
    }

    // ------------------------------------------------------------
    // 3) SPY price + regime charts
    // ------------------------------------------------------------

    function renderSpyPriceAndRegimeCharts(snap) {
      const containerPrice = document.getElementById('spy-price-chart');
      if (!containerPrice) return;

      const candles = (snap.chart && snap.chart.candles) || [];
      const regimes = (snap.chart && snap.chart.regimes) || [];
      if (!candles.length) return;

      const priceChart = createChart(containerPrice, {
        layout: {
          background: { color: '#020617' },
          textColor: '#e5e7eb',
        },
        rightPriceScale: {
          borderColor: '#1f2937',
        },
        timeScale: {
          borderColor: '#1f2937',
        },
        grid: {
          vertLines: { color: '#020617' },
          horzLines: { color: '#020617' },
        },
        crosshair: {
          mode: 0,
        },
      });

      // Use the same area/line style as the performance chart for consistency.
      const priceSeries = priceChart.addAreaSeries({
        lineColor: '#38bdf8',
        topColor: 'rgba(56, 189, 248, 0.25)',
        bottomColor: 'rgba(56, 189, 248, 0.0)',
      });

      priceSeries.setData(
        candles.map(c => ({
          time: c.time,
          value: c.close,
        }))
      );

      // Overlay regime strip on the same chart using a dedicated price scale.
      const regimeSeries = priceChart.addHistogramSeries({
        priceFormat: { type: 'price', precision: 0, minMove: 1 },
        priceScaleId: 'regime',
        priceLineVisible: false,
        lastValueVisible: false,
      });
      priceChart.priceScale('regime').applyOptions({
        scaleMargins: { top: 0.9, bottom: 0 },
        borderVisible: false,
      });

      const stripData = regimes.map(r => {
        const isBull = String(r.regime || '').toUpperCase() === 'BULL';
        return {
          time: r.time,
          value: 1,
          color: isBull ? '#22c55e55' : '#ef4444aa',
        };
      });
      regimeSeries.setData(stripData);

      // Trade markers (if any)
      const trades = snap.trades || [];
      const markers = trades.map(tr => {
        const side = (tr.side || tr.trade || '').toUpperCase();
        return {
          time: tr.time,
          position: side === 'BUY' ? 'belowBar' : 'aboveBar',
          color: side === 'BUY' ? '#22c55e' : '#ef4444',
          shape: side === 'BUY' ? 'arrowUp' : 'arrowDown',
          text: side === 'BUY' ? 'Buy' : 'Sell',
        };
      });

      // Add marker for start of live trades (2024-12-31) if within data.
      const LIVE_START = '2024-12-31';
      const liveStartCandle = candles.find(c => c.time === LIVE_START);
      if (liveStartCandle) {
        markers.push({
          time: LIVE_START,
          position: 'aboveBar',
          color: '#fbbf24',
          shape: 'arrowDown',
          text: 'Live starts',
        });
      }

      if (markers.length > 0) {
        priceSeries.setMarkers(markers);
      }

      // Initial view: past 12 months (if available)
      const parseDate = s => {
        const [y, m, d] = s.split('-').map(Number);
        return new Date(Date.UTC(y, m - 1, d));
      };
      const lastTime = parseDate(candles[candles.length - 1].time);
      const fromTime = new Date(lastTime);
      fromTime.setUTCFullYear(fromTime.getUTCFullYear() - 1);
      priceChart.timeScale().setVisibleRange({
        from: fromTime.toISOString().slice(0, 10),
        to: lastTime.toISOString().slice(0, 10),
      });
    }

    // ------------------------------------------------------------
    // 4) SPY equity chart (overlay vs SPY B&H)
    // ------------------------------------------------------------

    function renderSpyEquityChart(snap) {
      const container = document.getElementById('spy-equity-chart');
      if (!container) return;

      const eq = snap.equity_curve || [];
      if (!eq.length) return;

      const chart = createChart(container, {
        layout: {
          background: { color: '#020617' },
          textColor: '#e5e7eb',
        },
        rightPriceScale: {
          borderColor: '#1f2937',
        },
        timeScale: {
          borderColor: '#1f2937',
        },
        grid: {
          vertLines: { color: '#020617' },
          horzLines: { color: '#020617' },
        },
      });
      chart.applyOptions({
        localization: {
          priceFormatter: v => fmtNumber(v, 0),
        },
      });

      const overlaySeries = chart.addAreaSeries({
        lineColor: '#22c55e',
        topColor: 'rgba(34, 197, 94, 0.25)',
        bottomColor: 'rgba(34, 197, 94, 0.0)',
        priceLineVisible: false,
      });

      const spySeries = chart.addAreaSeries({
        lineColor: '#38bdf8',
        topColor: 'rgba(56, 189, 248, 0.25)',
        bottomColor: 'rgba(56, 189, 248, 0.0)',
        priceLineVisible: false,
      });

      const overlayData = [];
      const spyData = [];

      for (const row of eq) {
        overlayData.push({
          time: row.time,
          value: row.overlay ?? row.equity ?? null,
        });
        spyData.push({
          time: row.time,
          value: row.spy_bh ?? row.spy ?? null,
        });
      }

      overlaySeries.setData(overlayData);
      spySeries.setData(spyData);
      chart.timeScale().fitContent();
    }

    // ------------------------------------------------------------
    // 5) SWAN live stats & equity chart
    // ------------------------------------------------------------

    function renderSwanStatsAndChart(snap) {
      const statsOverlay = snap.stats_live_swan_overlay || {};
      const statsSwanBh = snap.stats_live_swan_bh || {};
      const statsSpyBh = snap.stats_live_spy_bh || {};
      const curve = snap.equity_curve || [];

      const overlayMetricsEl = document.getElementById('swan-live-overlay-metrics');
      const bhMetricsEl = document.getElementById('swan-live-bh-metrics');
      const spyMetricsEl = document.getElementById('swan-live-spy-metrics');

      const fmtSharpe = v => ((v ?? NaN).toFixed ? v.toFixed(2) : '–');

      if (overlayMetricsEl) {
        overlayMetricsEl.textContent = `(CAGR: ${fmtPct(statsOverlay.cagr ?? NaN, 1)}, Sharpe: ${fmtSharpe(statsOverlay.sharpe)})`;
      }
      if (bhMetricsEl) {
        bhMetricsEl.textContent = `(CAGR: ${fmtPct(statsSwanBh.cagr ?? NaN, 1)}, Sharpe: ${fmtSharpe(statsSwanBh.sharpe)})`;
      }
      if (spyMetricsEl) {
        spyMetricsEl.textContent = `(CAGR: ${fmtPct(statsSpyBh.cagr ?? NaN, 1)}, Sharpe: ${fmtSharpe(statsSpyBh.sharpe)})`;
      }

      const container = document.getElementById('swan-equity-chart');
      if (!container || !curve.length) return;

      const chart = createChart(container, {
        layout: {
          background: { color: '#020617' },
          textColor: '#e5e7eb',
        },
        rightPriceScale: {
          borderColor: '#1f2937',
        },
        timeScale: {
          borderColor: '#1f2937',
        },
        grid: {
          vertLines: { color: '#020617' },
          horzLines: { color: '#020617' },
        },
      });
      chart.applyOptions({
        localization: {
          priceFormatter: v => fmtNumber(v, 0),
        },
      });

      const overlaySeries = chart.addAreaSeries({
        lineColor: '#22c55e',
        topColor: 'rgba(34, 197, 94, 0.25)',
        bottomColor: 'rgba(34, 197, 94, 0.0)',
        priceLineVisible: false,
      });
      const swanBhSeries = chart.addAreaSeries({
        lineColor: '#f97316',
        topColor: 'rgba(249, 115, 22, 0.25)',
        bottomColor: 'rgba(249, 115, 22, 0.0)',
        priceLineVisible: false,
      });
      const spyBhSeries = chart.addAreaSeries({
        lineColor: '#38bdf8',
        topColor: 'rgba(56, 189, 248, 0.25)',
        bottomColor: 'rgba(56, 189, 248, 0.0)',
        priceLineVisible: false,
      });

      const overlayData = [];
      const swanBhData = [];
      const spyBhData = [];

      for (const row of curve) {
        overlayData.push({ time: row.time, value: row.swan_overlay });
        swanBhData.push({ time: row.time, value: row.swan_bh });
        spyBhData.push({ time: row.time, value: row.spy_bh });
      }

      overlaySeries.setData(overlayData);
      swanBhSeries.setData(swanBhData);
      spyBhSeries.setData(spyBhData);

      chart.timeScale().fitContent();
    }

    // ------------------------------------------------------------
    // 6) Backtest rendering
    // ------------------------------------------------------------

    function renderBacktest(bt) {
      const full = bt.full_period || null;
      const subsRaw = bt.subperiods || {};
      const notes = bt.notes || [];
      const meta = bt.meta || {};

      const humanizeLabel = key =>
        key
          .split('_')
          .map(w => w.charAt(0).toUpperCase() + w.slice(1))
          .join(' ');

      const formatRange = (start, end) =>
        start && end ? `${start} → ${end}` : '';

      const subs = Array.isArray(subsRaw)
        ? subsRaw
        : Object.entries(subsRaw).map(([key, val]) => ({
            label: val?.label || humanizeLabel(key),
            ...val,
          }));

      if (full) {
        const s = full.strategy || full.overlay || {};
        const b = full.spy || {};
        const fullLabel =
          full.label ||
          formatRange(s.start_date, s.end_date) ||
          formatRange(meta.backtest_start, meta.backtest_end) ||
          'Full period';
        subs.unshift({
          label: fullLabel,
          overlay: s,
          spy: b,
        });
      }

      const tbody = document.getElementById('bt-subperiod-body');
      if (tbody) {
        tbody.innerHTML = '';
        let band = false;
        for (const sp of subs) {
          band = !band;
          const bandClass = band ? 'bg-slate-900/60' : 'bg-slate-900/40';
          const s = sp.strategy || sp.overlay || {};
          const b = sp.spy || {};
          const label =
            sp.label ||
            formatRange(s.start_date, s.end_date) ||
            formatRange(b.start_date, b.end_date) ||
            '';

          const rowOverlay = document.createElement('tr');
          rowOverlay.className = bandClass;
          rowOverlay.innerHTML = `
            <td class="pr-3 py-1 rounded-l-lg text-slate-200" rowspan="2">${label}</td>
            <td class="pr-3 py-1 font-semibold text-emerald-300">Regime-Based SPY Allocation</td>
            <td class="pr-3 py-1 text-right">${fmtPct(s.cagr ?? NaN, 1)}</td>
            <td class="pr-3 py-1 text-right">${(s.sharpe ?? NaN).toFixed ? s.sharpe.toFixed(2) : '–'}</td>
            <td class="pr-3 py-1 text-right rounded-r-lg">${fmtPct(s.max_dd ?? NaN, 1)}</td>
          `;

          const rowSpy = document.createElement('tr');
          rowSpy.className = bandClass;
          rowSpy.innerHTML = `
            <td class="pr-3 py-1 font-semibold text-slate-200">SPY Buy &amp; Hold</td>
            <td class="pr-3 py-1 text-right">${fmtPct(b.cagr ?? NaN, 1)}</td>
            <td class="pr-3 py-1 text-right">${(b.sharpe ?? NaN).toFixed ? b.sharpe.toFixed(2) : '–'}</td>
            <td class="pr-3 py-1 text-right rounded-r-lg">${fmtPct(b.max_dd ?? NaN, 1)}</td>
          `;

          tbody.appendChild(rowOverlay);
          tbody.appendChild(rowSpy);
        }
      }

      // Append extra notes (optional)
      if (notes.length) {
        const disclaimerBlock = document.querySelector(
          '#bt-subperiod-body'
        )?.parentElement?.parentElement?.nextElementSibling;
        if (disclaimerBlock) {
          const ul = document.createElement('ul');
          ul.className = 'list-disc list-inside space-y-0.5 mt-1';
          notes.forEach(n => {
            const li = document.createElement('li');
            li.textContent = n;
            ul.appendChild(li);
          });
          disclaimerBlock.appendChild(ul);
        }
      }
    }

    // Boot
    window.addEventListener('DOMContentLoaded', initPage);    
  </script>
</body>
</html>
